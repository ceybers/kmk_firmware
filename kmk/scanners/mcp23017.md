# MCP23017 Scanner

The default KMK Scanners/CircuitPython keypad library doesn't seem to support MCP23017 I/O expanders for *both* input and output matrix pins. If you've followed the [Adafruit MCP23017 library tutorial](https://docs.circuitpython.org/projects/mcp230xx/en/latest/) and tried to apply it KMK, you might have stumbled across an error saying that `mcp.get_pin(n) is of type DigitalInOut and not type Pin`.

To solve this, I wrote a new scanner, `MCPScanner`, which uses the [Adafruit CircuitPython MCP230xx library](https://github.com/adafruit/Adafruit_CircuitPython_MCP230xx) to reference the pins, and implements `scan_for_changes()` using the appropriate code for polling the switch matrix when using MCP pins.

In addition to this fork/branch, you'll need to copy the `adafruit_mcp230xx` folder from their library to the `lib` folder on your Pico's USB drive.

You can find my keymap for this under `user_keymaps\mcp23017\mcp23017.py`, but for convenience, you'll want to update your keymap to look something like this:

```python
from kmk.scanners.mcpscanner import MCPScanner

i2c = busio.I2C(scl=board.GP1, sda=board.GP0, frequency=400000)

keyboard = KMKKeyboard()
keyboard.matrix = [
    MCPScanner( # LHS MCP23017 I/O Expander
        row_pins = [0, 1, 2, 3],
        col_pins = [8, 9, 10, 11, 12, 13],
        i2c = i2c,
        i2c_address = 0x20,
        offset = 0
    ),
    MCPScanner( # RHS MCP23017 I/O Expander
        row_pins = [0, 1, 2, 3],
        col_pins = [8, 9, 10, 12, 11, 13],
        i2c = i2c,
        i2c_address = 0x24,
        offset = 24
    )
]
keyboard.diode_orientation = DiodeOrientation.COL2ROW
keyboard.coord_mapping = [
    0,   1,  2,  3,  4,  5,     24, 25, 26, 27, 28, 29,
    6,   7,  8,  9, 10, 11,     30, 31, 32, 33, 34, 35,
    12, 13, 14, 15, 16, 17,     36, 37, 38, 39, 40, 41,
    18, 19, 20, 21, 22, 23,     42, 43, 44, 45, 46, 47
    ]
```

# References
- [GitHub - adafruit/Adafruit_CircuitPython_MCP230xx: CircuitPython driver for MCP230xx GPIO Expanders](https://github.com/adafruit/Adafruit_CircuitPython_MCP230xx)
- [Introduction — Adafruit MCP230xx Library 1.0 documentation](https://docs.circuitpython.org/projects/mcp230xx/en/latest/)
- [kmk_firmware/scanners.md at master · KMKfw/kmk_firmware · GitHub](https://github.com/KMKfw/kmk_firmware/blob/master/docs/en/scanners.md)